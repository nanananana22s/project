from aiogram import Router
from aiogram.filters import CommandStart
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext

from app.states.user_states import User
from useful_funcs.user.funcs import correction_name, check_phone_number, is_leap_year
from app.keyboards.universal_keyboard import completing_keyboard
from app.keyboards.user_keyboards.inline_keyboards import (choice_sex_keyboard,
                                                           choice_project_keyboard,
                                                           years_calendar,
                                                           month_kalendar_keyboard,
                                                           generate_days_keyboard,
                                                           choice_mistake
                                                           )

user_start_router = Router()


@user_start_router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    await message.answer(
        "ÐŸÑ€Ð¸Ð²ÐµÑ‚, ÐºÐ¾Ð»Ð»ÐµÐ³Ð°!ðŸ‘‹\n"
        "Ð¯ Ð±Ð¾Ñ‚ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¹ Â«Ð“Ð ÐÐ¡Ð¢Â».\n"
        "Ð“Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ñ‚ÐµÐ±Ðµ Ñ Ð¿Ð¾Ð¸ÑÐºÐ¾Ð¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸, Ð²Ñ‹ÑÐ»ÑƒÑˆÐ°Ñ‚ÑŒ Ñ‚Ð²Ð¾Ð¸ Ð¸Ð´ÐµÐ¸ Ð¿Ð¾ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² Ð¸ "
        "Ñ€Ð°ÑÑÐºÐ°Ð·Ð°Ñ‚ÑŒ ÐºÐ°Ðº Ð¸ Ð³Ð´Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑÑ‚Ð¸ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ðµ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ðµ!\n"
        "Ð”Ð°Ð²Ð°Ð¹ Ð¿Ð¾Ð·Ð½Ð°ÐºÐ¾Ð¼Ð¸Ð¼ÑÑ!\n"
        "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð·Ð¾Ð²Ð¸ ÑÐ²Ð¾Ñ‘ Ð¸Ð¼Ñ"
    )
    await state.set_state(User.registration_first_name)


@user_start_router.message(User.registration_first_name)
async def registration_middle_name(message: Message, state: FSMContext):
    if all(char.isalpha() or char in ['-', ' '] for char in message.text):
        correct_text = correction_name(message.text)
        await message.answer('Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾!\nÐ¢ÐµÐ¿ÐµÑ€ÑŒ Ð½Ð°Ð·Ð¾Ð²Ð¸, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° ÑÐ²Ð¾ÑŽ Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ')
        await state.set_state(User.registration_middle_name)
        await state.update_data(first_name=correct_text)
    else:
        await message.answer('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ð²Ð¾Ð´Ð°.')


@user_start_router.message(User.registration_middle_name)
async def registration_last_name(message: Message, state: FSMContext):
    if all(char.isalpha() or char in ['-', ' '] for char in message.text):
        correct_text = correction_name(message.text)
        await message.answer('Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾!\nÐ¢ÐµÐ¿ÐµÑ€ÑŒ Ð½Ð°Ð·Ð¾Ð²Ð¸, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° ÑÐ²Ð¾Ðµ Ð¾Ñ‚Ñ‡ÐµÑÑ‚Ð²Ð¾')
        await state.set_state(User.registration_last_name)
        await state.update_data(middle_name=correct_text)
    else:
        await message.answer('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ð²Ð¾Ð´Ð°.')


@user_start_router.message(User.registration_last_name)
async def registration_year(message: Message, state: FSMContext):
    if all(char.isalpha() or char in ['-', ' '] for char in message.text):
        correct_text = correction_name(message.text)
        new_info = years_calendar()
        await state.update_data(default_buttons_list=new_info[0])
        await message.answer(text='Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾!\nÐ’Ñ‹Ð±ÐµÑ€Ð¸ Ð³Ð¾Ð´ ÑÐ²Ð¾ÐµÐ³Ð¾ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ.', reply_markup=new_info[1])
        await state.set_state(User.registration_year)
        await state.update_data(last_name=correct_text)
    else:
        await message.answer('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ð²Ð¾Ð´Ð°.')


@user_start_router.callback_query(User.registration_year)
async def registration_month(callback: CallbackQuery, state: FSMContext):
    if callback.data == '>' or callback.data == '<':
        data = await state.get_data()
        new_info = years_calendar(default_buttons_list=data['default_buttons_list'], operation=callback.data)
        await state.update_data(default_buttons_list=new_info[0])
        await callback.message.edit_text(text='Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾!\nÐ’Ñ‹Ð±ÐµÑ€Ð¸ Ð³Ð¾Ð´ ÑÐ²Ð¾ÐµÐ³Ð¾ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ.', reply_markup=new_info[1])

    else:
        await state.update_data(year=callback.data)
        await state.set_state(User.registration_month)
        await callback.message.edit_text(text='Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾!\nÐ’Ñ‹Ð±ÐµÑ€Ð¸ Ð¼ÐµÑÑÑ† ÑÐ²Ð¾ÐµÐ³Ð¾ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ.',
                                         reply_markup=month_kalendar_keyboard)


@user_start_router.callback_query(User.registration_month)
async def registration_day(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    leap = is_leap_year(data['year'])
    keyboard = generate_days_keyboard(leap, callback.data)
    await callback.message.edit_text(text="Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾!\nÐ’Ñ‹Ð±ÐµÑ€Ð¸ Ð´ÐµÐ½ÑŒ ÑÐ²Ð¾ÐµÐ³Ð¾ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ.", reply_markup=keyboard)
    await state.update_data(month=callback.data)
    if 'sex' in data:
        await state.set_state(User.registration_correction_callback)
    else:
        await state.set_state(User.registration_day)


@user_start_router.callback_query(User.registration_day)
async def registration_sex(callback: CallbackQuery, state: FSMContext):
    await state.set_state(User.registration_sex)
    await state.update_data(day=callback.data)
    await callback.message.answer(text='Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾!\nÐšÐ°ÐºÐ¾Ð³Ð¾ Ñ‚Ñ‹ Ð¿Ð¾Ð»Ð°?', reply_markup=choice_sex_keyboard)
    await state.set_state(User.registration_sex)


@user_start_router.callback_query(User.registration_sex)
async def registration_position(callback: CallbackQuery, state: FSMContext):
    await state.update_data(sex=callback.data)
    await callback.message.answer('Ð¡ÑƒÐ¿ÐµÑ€!\nÐšÐ°ÐºÐ°Ñ Ñƒ Ñ‚ÐµÐ±Ñ Ð´Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ?')
    await state.set_state(User.registration_position)


@user_start_router.message(User.registration_position)
async def registration_project(message: Message, state: FSMContext):
    await state.update_data(position=message.text)
    await message.answer(text='Ð—Ð´Ð¾Ñ€Ð¾Ð²Ð¾!\nÐ’ ÐºÐ°ÐºÐ¾Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹ Ñ‚Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑˆÑŒ?', reply_markup=choice_project_keyboard)
    await state.set_state(User.registration_project)


@user_start_router.callback_query(User.registration_project)
async def registration_phone_number(callback: CallbackQuery, state: FSMContext):
    await state.update_data(project=callback.data)
    await state.set_state(User.registration_phone_number)
    await callback.message.answer('ÐšÑ€ÑƒÑ‚Ð¾!\nÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ - Ð½Ð°Ð¿Ð¸ÑˆÐ¸, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ²Ð¾Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°')


@user_start_router.message(User.registration_phone_number)
async def registration_end(message: Message, state: FSMContext):
    if all(char.isdigit() or char in ['+'] for char in message.text):
        correction_phone_num = check_phone_number(message.text)
        await state.update_data(phone_num=correction_phone_num)
        data = await state.get_data()
        await state.set_state(User.registration_end)
        await message.answer(text=f"Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹! \nÐ¢ÐµÐ¿ÐµÑ€ÑŒ Ð´Ð°Ð²Ð°Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ð¼, Ð²ÐµÑ€Ð½Ð¾ Ð»Ð¸ Ñ Ð²ÑÑ‘ Ð·Ð°Ð¿Ð¸ÑÐ°Ð»:"
                                  f"\nÐ˜Ð¼Ñ {data['first_name']} "
                                  f"\nÐ¤Ð°Ð¼Ð¸Ð»Ð¸Ñ {data['middle_name']}"
                                  f"\nÐžÑ‚Ñ‡ÐµÑÑ‚Ð²Ð¾ {data['last_name']}"
                                  f"\nÐ”Ð°Ñ‚Ð° Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ {data['day']} {data['month']} {data['year']}"
                                  f"\nÐŸÐ¾Ð» {data['sex']}"
                                  f"\nÐ”Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ {data['position']}"
                                  f"\nÐŸÑ€Ð¾ÐµÐºÑ‚ {data['project']}"
                                  f"\nÐÐ¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° {data['phone_num']}",
                             reply_markup=completing_keyboard)
    else:
        await message.answer('ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð½Ð¾Ð¼ÐµÑ€Ð° Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°!')


@user_start_router.callback_query(User.registration_end)
async def check_info(callback: CallbackQuery, state: FSMContext):
    if callback.data == 'Ð”Ð°':
        await callback.message.answer(text='Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹! Ð–ÐµÐ»Ð°ÑŽ Ñ…Ð¾Ñ€Ð¾ÑˆÐµÐ³Ð¾ Ð´Ð½Ñ Ð¸ Ð¿Ñ€Ð¸ÑÑ‚Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹!')
        await state.clear()
    else:
        await state.set_state(User.registration_check_info)
        await callback.message.answer(text='Ð˜Ð·Ð²Ð¸Ð½ÑÑŽÑÑŒ Ð·Ð° Ð¿ÑƒÑ‚Ð°Ð½Ð¸Ñ†Ñƒ, Ð´Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ð¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿ÑƒÐ½ÐºÑ‚ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ '
                                           'Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ.',
                                      reply_markup=choice_mistake)


@user_start_router.callback_query(User.registration_check_info)
async def correct_mistake(callback: CallbackQuery, state: FSMContext):
    if callback.data == 'Ð˜Ð¼Ñ':
        await state.update_data(first_name='')
        await callback.message.answer("ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð·Ð¾Ð²Ð¸ ÑÐ²Ð¾Ñ‘ Ð¸Ð¼Ñ")
        await state.set_state(User.registration_correction_message)
    if callback.data == 'Ð¤Ð°Ð¼Ð¸Ð»Ð¸Ñ':
        await state.update_data(middle_name='')
        await callback.message.answer("ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð·Ð¾Ð²Ð¸ ÑÐ²Ð¾ÑŽ Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ")
        await state.set_state(User.registration_correction_message)
    if callback.data == 'ÐžÑ‚Ñ‡ÐµÑÑ‚Ð²Ð¾':
        await state.update_data(last_name='')
        await callback.message.answer("ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð·Ð¾Ð²Ð¸ ÑÐ²Ð¾Ñ‘ Ð¾Ñ‚Ñ‡ÐµÑÑ‚Ð²Ð¾")
        await state.set_state(User.registration_correction_message)
    if callback.data == 'Ð“Ð¾Ð´ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ':
        new_info = years_calendar()
        await state.update_data(default_buttons_list=new_info[0])
        await callback.message.answer(text='Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð³Ð¾Ð´ ÑÐ²Ð¾ÐµÐ³Ð¾ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ.', reply_markup=new_info[1])
        await state.set_state(User.registration_year)
    if callback.data == 'ÐŸÐ¾Ð»':
        await callback.message.answer(text='ÐšÐ°ÐºÐ¾Ð³Ð¾ Ñ‚Ñ‹ Ð¿Ð¾Ð»Ð°?', reply_markup=choice_sex_keyboard)
        await state.set_state(User.registration_correction_callback)
    if callback.data == 'Ð”Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ':
        await state.set_state(User.registration_correction_message)
        await state.update_data(position='')
        await callback.message.answer('ÐšÐ°ÐºÐ°Ñ Ñƒ Ñ‚ÐµÐ±Ñ Ð´Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ?')
    if callback.data == 'ÐŸÑ€Ð¾ÐµÐºÑ‚':
        await callback.message.answer(text='Ð’ ÐºÐ°ÐºÐ¾Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹ Ñ‚Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑˆÑŒ?', reply_markup=choice_project_keyboard)
        await state.set_state(User.registration_correction_callback)
    if callback.data == 'ÐÐ¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°':
        await state.set_state(User.registration_correction_message)
        await state.update_data(phone_num='')
        await callback.message.answer(text='ÐÐ°Ð¿Ð¸ÑˆÐ¸, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ²Ð¾Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°?')


@user_start_router.callback_query(User.registration_correction_callback)
async def correction_callback(callback: CallbackQuery, state: FSMContext):
    if callback.data.isdigit():
        await state.update_data(day=callback.data)
    elif callback.data == 'ÐœÑƒÐ¶' or callback.data == 'Ð–ÐµÐ½':
        await state.update_data(sex=callback.data)
    else:
        await state.update_data(position=callback.data)

    data = await state.get_data()
    await state.set_state(User.registration_end)
    await callback.message.answer(text=f"Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹! \nÐ¢ÐµÐ¿ÐµÑ€ÑŒ Ð´Ð°Ð²Ð°Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ð¼, Ð²ÐµÑ€Ð½Ð¾ Ð»Ð¸ Ñ Ð²ÑÑ‘ Ð·Ð°Ð¿Ð¸ÑÐ°Ð»:"
                              f"\nÐ˜Ð¼Ñ {data['first_name']} "
                              f"\nÐ¤Ð°Ð¼Ð¸Ð»Ð¸Ñ {data['middle_name']}"
                              f"\nÐžÑ‚Ñ‡ÐµÑÑ‚Ð²Ð¾ {data['last_name']}"
                              f"\nÐ”Ð°Ñ‚Ð° Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ {data['day']} {data['month']} {data['year']}"
                              f"\nÐŸÐ¾Ð» {data['sex']}"
                              f"\nÐ”Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ {data['position']}"
                              f"\nÐŸÑ€Ð¾ÐµÐºÑ‚ {data['project']}"
                              f"\nÐÐ¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° {data['phone_num']}",
                         reply_markup=completing_keyboard)


@user_start_router.message(User.registration_correction_message)
async def correction_messages(message: Message, state: FSMContext):
    data = await state.get_data()
    if 'first_name' in data or 'middle_name' or 'last_name' in data or 'position' or 'phone_num' in data:
        if data['first_name'] == '':
            correct_text = correction_name(message.text)
            await state.update_data(first_name=correct_text)
        if data['middle_name'] == '':
            correct_text = correction_name(message.text)
            await state.update_data(middle_name=correct_text)
        if data['last_name'] == '':
            correct_text = correction_name(message.text)
            await state.update_data(last_name=correct_text)
        if data['position'] == '':
            await state.update_data(position=message.text)
        if data['phone_num'] == '':
            correction_phone_num = check_phone_number(message.text)
            await state.update_data(phone_num=correction_phone_num)
        data = await state.get_data()
        await state.set_state(User.registration_end)
        await message.answer(text=f"Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹! \nÐ¢ÐµÐ¿ÐµÑ€ÑŒ Ð´Ð°Ð²Ð°Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ð¼, Ð²ÐµÑ€Ð½Ð¾ Ð»Ð¸ Ñ Ð²ÑÑ‘ Ð·Ð°Ð¿Ð¸ÑÐ°Ð»:"
                                  f"\nÐ˜Ð¼Ñ {data['first_name']} "
                                  f"\nÐ¤Ð°Ð¼Ð¸Ð»Ð¸Ñ {data['middle_name']}"
                                  f"\nÐžÑ‚Ñ‡ÐµÑÑ‚Ð²Ð¾ {data['last_name']}"
                                  f"\nÐ”Ð°Ñ‚Ð° Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ {data['day']} {data['month']} {data['year']}"
                                  f"\nÐŸÐ¾Ð» {data['sex']}"
                                  f"\nÐ”Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ {data['position']}"
                                  f"\nÐŸÑ€Ð¾ÐµÐºÑ‚ {data['project']}"
                                  f"\nÐÐ¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° {data['phone_num']}",
                             reply_markup=completing_keyboard)
